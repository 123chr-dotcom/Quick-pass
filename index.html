<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æé€Ÿæ–‡ä»¶åˆ†äº«</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- ä¸Šä¼ ç•Œé¢ -->
        <div id="uploadSection">
            <h1>ğŸ“¤ å¿«é€Ÿæ–‡ä»¶åˆ†äº«</h1>
            <div class="drop-zone" id="dropZone">
                <div class="icon">â¬†ï¸</div>
                <div class="text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ æˆ– æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                <input type="file" id="fileInput">
            </div>
            <div class="file-info hidden" id="fileInfo">
                <span id="fileName"></span>
                <span id="fileSize"></span>
            </div>
            <button class="btn hidden" id="generateBtn">ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
        </div>

        <!-- åˆ†äº«ç•Œé¢ -->
        <div id="shareSection" class="hidden">
            <h2>âœ… æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª</h2>
            <div class="share-box">
                <input type="text" id="shareLink" readonly>
                <div class="btn-group">
                    <button class="btn" onclick="copyLink()">å¤åˆ¶é“¾æ¥</button>
                    <button class="btn" onclick="newShare()">æ–°åˆ†äº«</button>
                </div>
                <p class="notice">æ­¤é“¾æ¥å°†åœ¨é¡µé¢å…³é—­åå¤±æ•ˆ</p>
            </div>
        </div>

        <!-- ä¸‹è½½ç•Œé¢ -->
        <div id="downloadSection" class="hidden">
            <h1>ğŸ“¥ æ–‡ä»¶æ¥æ”¶</h1>
            <div class="download-box">
                <div id="downloadInfo">
                    <span class="filename" id="dlFileName"></span>
                    <span class="filesize" id="dlFileSize"></span>
                </div>
                <a class="btn" id="downloadLink">ç«‹å³ä¸‹è½½</a>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢å…ƒç´ 
        const uploadSection = document.getElementById('uploadSection');
        const shareSection = document.getElementById('shareSection');
        const downloadSection = document.getElementById('downloadSection');
        const fileInput = document.getElementById('fileInput');
        const generateBtn = document.getElementById('generateBtn');

        // å…¨å±€å˜é‡
        let currentFile = null;
        const MAX_SIZE = 2 * 1024 * 1024; // 2MBé™åˆ¶

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function init() {
            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ”¾å¤„ç†
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            
            // ç”ŸæˆæŒ‰é’®
            generateBtn.addEventListener('click', generateShareLink);
            
            // é¡µé¢åŠ è½½æ£€æŸ¥
            checkUrlParams();
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > MAX_SIZE) {
                alert('æ–‡ä»¶å¤§å°è¶…è¿‡2MBé™åˆ¶ï¼Œè¯·ä½¿ç”¨å°æ–‡ä»¶åˆ†äº«');
                resetUI();
                return;
            }
            
            currentFile = file;
            showFileInfo(file);
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        function showFileInfo(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatSize(file.size);
            document.getElementById('fileInfo').classList.remove('hidden');
            generateBtn.classList.remove('hidden');
        }

        // ç”Ÿæˆåˆ†äº«é“¾æ¥
        async function generateShareLink() {
            if (!currentFile) return;
            
            const reader = new FileReader();
            reader.onload = () => {
                const base64Data = reader.result;
                const shareUrl = createShareUrl(currentFile.name, base64Data);
                
                uploadSection.classList.add('hidden');
                shareSection.classList.remove('hidden');
                document.getElementById('shareLink').value = shareUrl;
            };
            reader.readAsDataURL(currentFile);
        }

        // åˆ›å»ºåˆ†äº«URL
        function createShareUrl(filename, data) {
            const params = new URLSearchParams();
            params.set('file', filename);
            params.set('data', data.split(',')[1]); // ç§»é™¤data:å‰ç¼€
            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }

        // å¤åˆ¶é“¾æ¥
        function copyLink() {
            const input = document.getElementById('shareLink');
            input.select();
            document.execCommand('copy');
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }

        // æ–°åˆ†äº«
        function newShare() {
            window.location.href = window.location.origin + window.location.pathname;
        }

        // æ£€æŸ¥URLå‚æ•°
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const fileData = params.get('data');
            
            if (fileData) {
                handleDownload(params.get('file'), fileData);
            }
        }

        // å¤„ç†ä¸‹è½½
        function handleDownload(filename, base64Data) {
            const byteString = atob(base64Data);
            const arrayBuffer = new ArrayBuffer(byteString.length);
            const uintArray = new Uint8Array(arrayBuffer);
            
            for (let i = 0; i < byteString.length; i++) {
                uintArray[i] = byteString.charCodeAt(i);
            }
            
            const blob = new Blob([uintArray], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            uploadSection.classList.add('hidden');
            shareSection.classList.add('hidden');
            downloadSection.classList.remove('hidden');
            
            document.getElementById('dlFileName').textContent = decodeURIComponent(filename);
            document.getElementById('dlFileSize').textContent = formatSize(blob.size);
            document.getElementById('downloadLink').href = url;
            document.getElementById('downloadLink').download = decodeURIComponent(filename);
        }

        // æ‹–æ”¾å¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        }

        // é‡ç½®ç•Œé¢
        function resetUI() {
            fileInput.value = '';
            currentFile = null;
            document.getElementById('fileInfo').classList.add('hidden');
            generateBtn.classList.add('hidden');
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(unitIndex === 0 ? 0 : 1)} ${units[unitIndex]}`;
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>